<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel | Tessyâ€™s Beauty Academy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>body { font-family: 'Nunito', sans-serif; }</style>
</head>
<body class="bg-pink-50 min-h-screen">

<header class="bg-white shadow-sm fixed top-0 w-full z-50">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-pink-700 font-semibold text-lg">ðŸ”§ Admin Panel</h1>
    <button id="logoutBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-none hover:bg-gray-400">Logout</button>
  </div>
</header>

<main class="pt-24 max-w-7xl mx-auto px-4 pb-16">
  <!-- LOGIN -->
  <div id="loginBox" class="max-w-md mx-auto mt-12 bg-white p-6 rounded-none shadow-sm">
    <h2 class="text-xl font-semibold mb-4">Connexion Admin</h2>
    <input type="text" id="adminUser" placeholder="Nom dâ€™utilisateur"
           class="w-full border px-4 py-2 rounded-none mb-3 focus:outline-none focus:ring-2 focus:ring-pink-500">
    <input type="password" id="adminPass" placeholder="Mot de passe"
           class="w-full border px-4 py-2 rounded-none mb-3 focus:outline-none focus:ring-2 focus:ring-pink-500">
    <button id="loginBtn" class="w-full bg-pink-600 text-white py-2 rounded-none hover:bg-pink-700">Se connecter</button>
    <p id="loginError" class="text-red-600 text-sm mt-2 hidden">Nom dâ€™utilisateur ou mot de passe incorrect</p>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden space-y-6">

    <!-- USERS TABLE -->
    <div class="bg-white p-6 rounded-none shadow-sm">
      <h3 class="font-semibold text-lg mb-4">ðŸ‘¥ Utilisateurs</h3>
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="bg-pink-100">
            <th class="border px-2 py-1">Nom</th>
            <th class="border px-2 py-1">Email</th>
            <th class="border px-2 py-1">Status</th>
            <th class="border px-2 py-1">Action</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
    </div>

    <!-- CERTIFICATES TABLE -->
    <div class="bg-white p-6 rounded-none shadow-sm">
      <h3 class="font-semibold text-lg mb-4">ðŸŽ“ Certificats</h3>
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="bg-pink-100">
            <th class="border px-2 py-1">ID Certificat</th>
            <th class="border px-2 py-1">Utilisateur</th>
            <th class="border px-2 py-1">Cours</th>
            <th class="border px-2 py-1">Action</th>
          </tr>
        </thead>
        <tbody id="certTable"></tbody>
      </table>
    </div>

  </div>
</main>

<script>
/* ==========================
   CONFIG
========================== */
const WORKER_URL = "https://academy-api.tessysbeautyy.workers.dev/courses/auth";
const ADMIN_API_KEY = "tBA3R8v2kL9qXz5mN0yH"; // <--- your new key
const CORS_HEADERS = {
  "Content-Type": "application/json",
  "x-api-key": ADMIN_API_KEY
};

/* ==========================
   ELEMENTS
========================== */
const loginBox = document.getElementById("loginBox");
const dashboard = document.getElementById("dashboard");
const userTable = document.getElementById("userTable");
const certTable = document.getElementById("certTable");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginError = document.getElementById("loginError");

/* ==========================
   STATIC DEMO DATA (REPLACE WITH LIVE DATA AFTER LOGIN)
========================== */
let mockUsers = [];
let mockCerts = [];

/* ==========================
   DASHBOARD RENDER
========================== */
function showDashboard() {
  loginBox.classList.add("hidden");
  dashboard.classList.remove("hidden");
  fetchUsersAndCerts();
}

function populateUsers() {
  userTable.innerHTML = "";
  mockUsers.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border px-2 py-1">${u.name}</td>
      <td class="border px-2 py-1">${u.email}</td>
      <td class="border px-2 py-1">${u.status}</td>
      <td class="border px-2 py-1 space-x-2">
        <button class="px-2 py-1 bg-green-600 text-white rounded-none hover:bg-green-700" onclick="activateUser('${u.id}')">Activer</button>
      </td>
    `;
    userTable.appendChild(tr);
  });
}

function populateCerts() {
  certTable.innerHTML = "";
  mockCerts.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border px-2 py-1">${c.id}</td>
      <td class="border px-2 py-1">${c.user}</td>
      <td class="border px-2 py-1">${c.course}</td>
      <td class="border px-2 py-1">
        <button class="px-2 py-1 bg-pink-600 text-white rounded-none hover:bg-pink-700" onclick="revokeCert('${c.id}')">RÃ©voquer</button>
      </td>
    `;
    certTable.appendChild(tr);
  });
}

/* ==========================
   FETCH USERS & CERTS
========================== */
async function fetchUsersAndCerts() {
  try {
    // USERS
    const usersRes = await fetch("https://academy-api.tessysbeautyy.workers.dev/courses/dashboard", {
      headers: CORS_HEADERS
    });
    mockUsers = await usersRes.json();
    populateUsers();

    // CERTIFICATES
    const certRes = await fetch("https://academy-api.tessysbeautyy.workers.dev/courses/certificate", {
      headers: CORS_HEADERS
    });
    mockCerts = await certRes.json();
    populateCerts();
  } catch (err) {
    console.error("Error fetching dashboard:", err);
  }
}

/* ==========================
   ACTIONS
========================== */
async function activateUser(id) {
  const user = mockUsers.find(u => u.id === id);
  if (user) {
    // Call worker endpoint to update user status
    try {
      await fetch(`https://academy-api.tessysbeautyy.workers.dev/courses/dashboard/activate/${id}`, {
        method: "POST",
        headers: CORS_HEADERS
      });
      user.status = "active";
      populateUsers();
      alert(`Utilisateur ${user.name} activÃ© âœ”ï¸`);
    } catch (err) {
      alert("Failed to activate user");
    }
  }
}

async function revokeCert(id) {
  const index = mockCerts.findIndex(c => c.id === id);
  if (index !== -1) {
    try {
      await fetch(`https://academy-api.tessysbeautyy.workers.dev/courses/certificate/revoke/${id}`, {
        method: "POST",
        headers: CORS_HEADERS
      });
      mockCerts.splice(index, 1);
      populateCerts();
      alert(`Certificat ${id} rÃ©voquÃ© âœ”ï¸`);
    } catch {
      alert("Failed to revoke certificate");
    }
  }
}

/* ==========================
   LOGIN & LOGOUT
========================== */
// AUTO LOGIN USING API KEY
document.addEventListener("DOMContentLoaded", () => {
  if (ADMIN_API_KEY) {
    sessionStorage.setItem("adminLoggedIn", "true");
    showDashboard();
  }
});

logoutBtn.onclick = () => {
  sessionStorage.removeItem("adminLoggedIn");
  location.reload();
};

// HIDE LOGIN FORM if API key is set
if (ADMIN_API_KEY) loginBox.classList.add("hidden");
</script>

</body>
</html>
